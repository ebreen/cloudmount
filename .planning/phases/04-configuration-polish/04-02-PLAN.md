---
phase: 04-configuration-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - Sources/CloudMount/MenuContentView.swift
  - Sources/CloudMount/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "Menu bar shows disk usage (or placeholder) for each mounted bucket"
    - "Settings window provides complete configuration management"
    - "Mount point field validates format"
    - "Disconnecting credentials clears persisted bucket configs"
  artifacts:
    - path: "Sources/CloudMount/MenuContentView.swift"
      provides: "Disk usage display per bucket in menu"
      contains: "ByteCountFormatter"
    - path: "Sources/CloudMount/SettingsView.swift"
      provides: "Mount point validation, disconnect clears persisted configs"
      contains: "Volumes"
  key_links:
    - from: "Sources/CloudMount/MenuContentView.swift"
      to: "Sources/CloudMount/CloudMountApp.swift"
      via: "appState.bucketConfigs[].totalBytesUsed"
      pattern: "totalBytesUsed"
    - from: "Sources/CloudMount/SettingsView.swift"
      to: "Sources/CloudMount/CloudMountApp.swift"
      via: "appState.clearAllBuckets()"
      pattern: "clearAllBuckets|BucketConfigStore"
---

<objective>
Add disk usage display in menu bar and polish settings for complete configuration experience.

Purpose: This is the final user-facing plan. Users see bucket sizes in the menu, and the settings window is fully functional with persistence and validation. Completes all Phase 4 requirements (CONFIG-01, CONFIG-02, UI-03, UI-05).
Output: Polished menu with disk usage, validated settings, complete config management.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-polish/04-RESEARCH.md
@.planning/phases/04-configuration-polish/04-01-SUMMARY.md
@Sources/CloudMount/MenuContentView.swift
@Sources/CloudMount/SettingsView.swift
@Sources/CloudMount/CloudMountApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Disk usage display in menu bar</name>
  <files>Sources/CloudMount/MenuContentView.swift</files>
  <action>
Update the bucketsSection in MenuContentView to show disk usage for mounted buckets.

1. **Modify the bucket row in bucketsSection** — In the ForEach over `appState.bucketConfigs`, where it currently shows `bucket.mountpoint` under the bucket name for mounted buckets, enhance it to also show disk usage:

   When `bucket.isMounted`:
   - Show mountpoint on one line (already exists)
   - Below that (or inline with a "·" separator), show formatted disk usage using `ByteCountFormatter.string(fromByteCount: bytes, countStyle: .file)` where `bytes` comes from `bucket.totalBytesUsed`
   - If `totalBytesUsed` is nil (not yet calculated), don't show anything for usage (clean look — avoid "Calculating..." noise since we return None for MVP)

   Layout for mounted bucket:
   ```
   [externaldrive.fill icon] bucket-name
                             /Volumes/bucket-name · 2.4 GB    [Unmount]
   ```

   If totalBytesUsed is nil, just show mountpoint without the "· size" part (this is the current behavior, so only add the size when available).

2. **Use ByteCountFormatter** — `ByteCountFormatter.string(fromByteCount: Int64, countStyle: .file)` returns strings like "2.4 GB", "156 KB", etc. It's a static method on ByteCountFormatter, no instance needed.

**Keep it minimal** — This is a small visual addition. Don't restructure the entire bucketsSection. Just add the usage text inline with the mountpoint when available.
  </action>
  <verify>
`swift build` succeeds. Inspect MenuContentView.swift to confirm ByteCountFormatter usage is present and conditional on totalBytesUsed being non-nil.
  </verify>
  <done>
Mounted buckets in menu show formatted disk usage (e.g., "2.4 GB") next to mountpoint when totalBytesUsed is available. No display when nil. ByteCountFormatter used for formatting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings polish — persistence wiring and mount point validation</name>
  <files>Sources/CloudMount/SettingsView.swift</files>
  <action>
Polish the settings window for complete configuration management.

1. **Fix disconnect to clear persisted configs** — In CredentialsPane's `disconnect()` method, it currently does `appState.bucketConfigs = []`. This bypasses AppState's save logic. Change it to call `appState.clearAllBuckets()` (the method created in Plan 01). If that method doesn't exist yet, call `appState.bucketConfigs.removeAll()` followed by `BucketConfigStore.save([])`. The key point: disconnecting must clear the persisted JSON file too, not just the in-memory array.

2. **Mount point validation in BucketsPane** — In the `addBucket()` function, validate the mount point:
   - If user provides a mount point, ensure it starts with "/" (absolute path). If not, prepend "/Volumes/".
   - The default "/Volumes/{name}" is fine as-is.
   - Show a brief validation hint under the mount point field: "Mount point must be an absolute path (e.g., /Volumes/my-bucket)"
   - This is light validation — macFUSE handles actual mount point creation. Don't over-validate.

3. **Minor visual polish** — Ensure the settings window frame is adequate. Currently `frame(width: 500, height: 350)`. If needed, increase height slightly to accommodate any new content (e.g., 380). Only change if the current size clips content.

**Do NOT change:**
- CredentialsPane form fields or connect flow (CONFIG-01 already works)
- BucketsPane bucket list or add form structure (CONFIG-02 already works)
- GeneralPane (launch at login toggle is fine as-is)
  </action>
  <verify>
`swift build` succeeds. Inspect SettingsView.swift to confirm: disconnect calls a method that also clears persisted configs, mount point gets basic validation.
  </verify>
  <done>
Disconnect clears both in-memory and persisted bucket configs. Mount point has basic format validation. Settings window is complete and polished. All CONFIG requirements satisfied.
  </done>
</task>

</tasks>

<verification>
1. `swift build` succeeds from project root
2. MenuContentView shows disk usage display code (ByteCountFormatter)
3. SettingsView disconnect clears persisted configs
4. Mount point validation present in BucketsPane
5. No regression — existing functionality preserved
</verification>

<success_criteria>
- Menu bar bucket rows show formatted disk usage when available
- Disconnect in settings clears persisted bucket configs
- Mount point field has basic validation
- `swift build` succeeds
- All Phase 4 requirements met: CONFIG-01 (credentials ✓ existing), CONFIG-02 (bucket config ✓ existing + persistence), UI-03 (disk usage display), UI-05 (settings window ✓ existing + polish)
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-polish/04-02-SUMMARY.md`
</output>
