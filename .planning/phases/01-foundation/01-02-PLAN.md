---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/macfuse.rs
  - src-tauri/src/lib.rs
  - src-tauri/src/commands.rs
  - src-tauri/Cargo.toml
  - src/components/MacFUSEDialog.tsx
  - src/App.tsx
autonomous: true
must_haves:
  truths:
    - "App detects if macFUSE is installed at launch"
    - "If macFUSE is missing, a clear dialog explains the requirement"
    - "Dialog provides link to macFUSE download page"
    - "App re-checks periodically and detects when macFUSE is installed"
  artifacts:
    - path: "src-tauri/src/macfuse.rs"
      provides: "macFUSE detection logic"
      exports: ["check_macfuse_installed", "MacFUSEStatus"]
    - path: "src-tauri/src/commands.rs"
      provides: "Tauri command for macFUSE check"
      exports: ["check_macfuse"]
    - path: "src/components/MacFUSEDialog.tsx"
      provides: "UI dialog for macFUSE installation guidance"
  key_links:
    - from: "src-tauri/src/macfuse.rs"
      to: "macOS filesystem"
      via: "Check for /Library/Filesystems/macfuse.fs existence"
    - from: "src-tauri/src/commands.rs"
      to: "src-tauri/src/macfuse.rs"
      via: "invoke check_macfuse_installed()"
    - from: "src/App.tsx"
      to: "src/components/MacFUSEDialog.tsx"
      via: "Conditional render based on macFUSE status"
---

<objective>
Implement macFUSE detection with installation guidance

Purpose: Ensure users know immediately if macFUSE is missing and provide clear guidance for installation. This is a critical dependency for the filesystem functionality.

Output: Automatic macFUSE detection at app launch, user-friendly dialog with installation instructions, and periodic re-checking to detect when macFUSE is installed.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/STACK.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

## Phase Context
This plan implements macFUSE detection which is required for MOUNT-04 and ERROR-03. The app must detect macFUSE at launch and guide users if it's missing.

## Key Decisions from Context
- Detection timing: Check at app launch
- If missing: Modal dialog with instructions (blocking until resolved)
- Installation guidance: Link to macFUSE website (not step-by-step in app)
- Re-checking: Auto-check periodically to detect when installed

## macFUSE Detection Method
macFUSE installs to `/Library/Filesystems/macfuse.fs` or `/System/Library/Filesystems/macfuse.fs`. Check for the existence of this directory.

## User Experience
1. App launches
2. Check for macFUSE
3. If missing: Show dialog explaining macFUSE is required
4. Dialog has "Download macFUSE" button linking to https://macfuse.io
5. Dialog has "Check Again" button to re-check
6. Once detected, dialog closes automatically
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create macFUSE detection module</name>
  <files>src-tauri/src/macfuse.rs, src-tauri/src/lib.rs</files>
  <action>
    Create a Rust module to detect macFUSE installation:
    
    1. Create src-tauri/src/macfuse.rs:
       - Define MacFUSEStatus enum: { Installed, NotInstalled }
       - Implement check_macfuse_installed() -> MacFUSEStatus:
         * Check if /Library/Filesystems/macfuse.fs exists
         * Check if /System/Library/Filesystems/macfuse.fs exists  
         * Return appropriate status
       - Implement get_macfuse_version() -> Option<String> (bonus: read version if installed)
       
    2. Update src-tauri/src/lib.rs:
       - Add pub mod macfuse;
       - Re-export MacFUSEStatus if needed
       
    3. Add tests in src-tauri/src/macfuse.rs:
       - Test that function returns a valid status (doesn't panic)
       
    Detection paths to check:
    - /Library/Filesystems/macfuse.fs (user install)
    - /System/Library/Filesystems/macfuse.fs (system install)
    - Check if the directory exists using std::path::Path
  </action>
  <verify>
    Run `cargo test` in src-tauri/ — macFUSE tests should pass
    Run `cargo check` — no compilation errors
  </verify>
  <done>
    macfuse.rs module exists with check_macfuse_installed() function. Returns Installed or NotInstalled based on filesystem check. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Tauri command and expose to frontend</name>
  <files>src-tauri/src/commands.rs, src-tauri/src/lib.rs</files>
  <action>
    Create Tauri command to expose macFUSE detection to frontend:
    
    1. Create src-tauri/src/commands.rs:
       - Define CheckMacFUSEResult struct { installed: bool, version: Option<String> }
       - Implement #[tauri::command] async fn check_macfuse() -> Result<CheckMacFUSEResult, String>
       - Call macfuse::check_macfuse_installed() internally
       - Return structured result for frontend consumption
       
    2. Update src-tauri/src/lib.rs:
       - Add pub mod commands;
       - In run() function, register command with .invoke_handler(tauri::generate_handler![commands::check_macfuse])
       
    3. Ensure proper error handling:
       - If filesystem check fails, return Err with descriptive message
       - Never panic — always return Result
       
    4. Add to capabilities (tauri.conf.json) if using Tauri v2 capabilities system:
       - Allow invoke for check_macfuse command
  </action>
  <verify>
    Run `cargo tauri dev`
    In browser console or via test: invoke('check_macfuse') should return { installed: true/false }
  </verify>
  <done>
    check_macfuse command registered and callable from frontend. Returns correct installation status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create macFUSE installation dialog UI</name>
  <files>src/components/MacFUSEDialog.tsx, src/App.tsx</files>
  <action>
    Create a user-friendly dialog for macFUSE installation guidance:
    
    1. Create src/components/MacFUSEDialog.tsx:
       - Props: { isOpen: boolean, onCheckAgain: () => void, onClose: () => void }
       - Dialog content:
         * Title: "macFUSE Required"
         * Explanation: "CloudMount requires macFUSE to mount cloud storage as local drives."
         * Primary button: "Download macFUSE" → opens https://macfuse.io in browser
         * Secondary button: "Check Again" → calls onCheckAgain prop
         * Note about Recovery Mode for kernel extension (brief mention)
       - Use native-looking dialog styling
       - Modal behavior (blocks interaction with rest of app)
       
    2. Update src/App.tsx:
       - Add state for macFUSE status: const [macfuseStatus, setMacfuseStatus] = useState<MacFUSEStatus | null>(null)
       - On app mount, call invoke('check_macfuse') to check status
       - Show MacFUSEDialog if status is NotInstalled
       - Handle "Check Again" by re-invoking check_macfuse
       - Once installed, dialog closes automatically
       
    3. Use Tauri API:
       - invoke('check_macfuse') from @tauri-apps/api/core
       - open('https://macfuse.io') from @tauri-apps/api/shell for opening browser
       
    4. Styling:
       - Centered modal dialog
       - Clear, friendly copy (not technical)
       - macOS-native appearance
  </action>
  <verify>
    Run `cargo tauri dev`
    If macFUSE not installed: Dialog appears with Download and Check Again buttons
    Click Download: Opens macfuse.io in browser
    Click Check Again: Re-checks and updates status
    Install macFUSE: Dialog should close automatically on next check
  </verify>
  <done>
    Dialog appears when macFUSE is missing. Download button opens browser. Check Again re-checks. Dialog closes when macFUSE detected. Clean, user-friendly experience.
  </done>
</task>

</tasks>

<verification>
1. App checks for macFUSE at launch
2. If missing, clear dialog explains requirement
3. Download button opens https://macfuse.io
4. Check Again button re-checks installation
5. Dialog closes automatically when macFUSE is detected
6. No technical jargon in user-facing messages
</verification>

<success_criteria>
- macFUSE detection works at app launch
- Missing macFUSE shows clear, friendly dialog
- User can download macFUSE with one click
- Re-check button works
- Dialog auto-closes when macFUSE installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
