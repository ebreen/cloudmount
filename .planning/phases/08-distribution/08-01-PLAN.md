---
phase: 08-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - project.yml
  - CloudMount/Info.plist
  - CloudMount/CloudMountApp.swift
  - CloudMount/Views/CheckForUpdatesView.swift
  - scripts/export-options.plist
autonomous: true

must_haves:
  truths:
    - "Sparkle framework is declared as SPM dependency and resolves in Xcode project"
    - "CloudMountApp creates SPUStandardUpdaterController and starts the updater"
    - "A 'Check for Updates…' menu item appears in the app menu"
    - "Info.plist has SUFeedURL and SUPublicEDKey keys (placeholder values OK)"
    - "Info.plist has proper CFBundleShortVersionString (2.0.0) and CFBundleVersion (1)"
    - "ExportOptions.plist exists with method=developer-id and signingStyle=manual"
  artifacts:
    - path: "project.yml"
      provides: "Sparkle SPM dependency declaration"
      contains: "sparkle-project/Sparkle"
    - path: "CloudMount/Info.plist"
      provides: "Version numbers + Sparkle feed config"
      contains: "SUFeedURL"
    - path: "CloudMount/CloudMountApp.swift"
      provides: "Sparkle updater initialization"
      contains: "SPUStandardUpdaterController"
    - path: "CloudMount/Views/CheckForUpdatesView.swift"
      provides: "Check for Updates menu command view"
      contains: "SPUUpdater"
    - path: "scripts/export-options.plist"
      provides: "Developer ID export configuration for xcodebuild"
      contains: "developer-id"
  key_links:
    - from: "project.yml"
      to: "CloudMount target"
      via: "SPM package dependency"
      pattern: "package:\\s*Sparkle"
    - from: "CloudMount/CloudMountApp.swift"
      to: "Sparkle framework"
      via: "import and SPUStandardUpdaterController init"
      pattern: "import Sparkle"
    - from: "CloudMount/Info.plist"
      to: "Sparkle runtime"
      via: "SUFeedURL + SUPublicEDKey keys"
      pattern: "SUFeedURL"
---

<objective>
Integrate Sparkle auto-update framework and prepare distribution configuration for Developer ID export.

Purpose: PKG-04 (version numbers), PKG-05 (Sparkle auto-update), and export configuration needed by the release pipeline. These are project-level changes that must exist before CI workflows can archive and export.

Output: project.yml with Sparkle SPM dep, updated Info.plist with version + Sparkle keys, CloudMountApp with updater, CheckForUpdatesView, and ExportOptions.plist for Developer ID distribution.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-distribution/08-RESEARCH.md
@.planning/phases/08-distribution/08-CONTEXT.md

@project.yml
@CloudMount/Info.plist
@CloudMount/CloudMountApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sparkle SPM dependency and update Info.plist</name>
  <files>
    project.yml
    CloudMount/Info.plist
  </files>
  <action>
    1. In `project.yml`, add Sparkle as a remote SPM package and as a dependency of the CloudMount target:
       - Under a top-level `packages:` key, add:
         ```yaml
         packages:
           Sparkle:
             url: https://github.com/sparkle-project/Sparkle
             from: "2.0.0"
         ```
       - In the CloudMount target's `dependencies:` array, add:
         ```yaml
         - package: Sparkle
         ```

    2. In `CloudMount/Info.plist`, update version numbers and add Sparkle keys:
       - Set `CFBundleShortVersionString` to `2.0.0` (SemVer display version)
       - Keep `CFBundleVersion` at `1` (will be auto-incremented by CI)
       - Add `SUFeedURL` key with string value `https://raw.githubusercontent.com/eirikbreen/cloudmount/main/appcast.xml`
       - Add `SUPublicEDKey` key with empty string value (placeholder — user will generate EdDSA keypair and fill in)

    Do NOT modify CODE_SIGN_STYLE or add signing identity to project.yml — CI will override via xcodebuild flags.
  </action>
  <verify>
    Run `xcodegen generate` and verify it succeeds without errors. Then run `xcodebuild -resolvePackageDependencies -project CloudMount.xcodeproj -scheme CloudMount` to confirm Sparkle resolves.
  </verify>
  <done>
    project.yml declares Sparkle SPM dependency. Info.plist has CFBundleShortVersionString=2.0.0, SUFeedURL, and SUPublicEDKey keys. xcodegen generates successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Sparkle updater in CloudMountApp + create ExportOptions.plist</name>
  <files>
    CloudMount/CloudMountApp.swift
    CloudMount/Views/CheckForUpdatesView.swift
    scripts/export-options.plist
  </files>
  <action>
    1. Create `CloudMount/Views/CheckForUpdatesView.swift`:
       ```swift
       import SwiftUI
       import Sparkle

       struct CheckForUpdatesView: View {
           @ObservedObject private var checkForUpdatesViewModel: CheckForUpdatesViewModel

           init(updater: SPUUpdater) {
               self.checkForUpdatesViewModel = CheckForUpdatesViewModel(updater: updater)
           }

           var body: some View {
               Button("Check for Updates…", action: checkForUpdatesViewModel.checkForUpdates)
                   .disabled(!checkForUpdatesViewModel.canCheckForUpdates)
           }
       }

       @MainActor
       final class CheckForUpdatesViewModel: ObservableObject {
           @Published var canCheckForUpdates = false
           private let updater: SPUUpdater

           init(updater: SPUUpdater) {
               self.updater = updater
               updater.publisher(for: \.canCheckForUpdates)
                   .assign(to: &$canCheckForUpdates)
           }

           func checkForUpdates() {
               updater.checkForUpdates()
           }
       }
       ```

    2. Update `CloudMount/CloudMountApp.swift`:
       - Add `import Sparkle` at top
       - Add a private property: `private let updaterController: SPUStandardUpdaterController`
       - Add an `init()` method that creates the updater controller:
         ```swift
         init() {
             updaterController = SPUStandardUpdaterController(
                 startingUpdater: true,
                 updaterDelegate: nil,
                 userDriverDelegate: nil
             )
         }
         ```
       - Add a `.commands` modifier to the Settings Window scene that adds "Check for Updates…" after .appInfo:
         ```swift
         .commands {
             CommandGroup(after: .appInfo) {
                 CheckForUpdatesView(updater: updaterController.updater)
             }
         }
         ```

    3. Create `scripts/export-options.plist`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>method</key>
           <string>developer-id</string>
           <key>signingStyle</key>
           <string>manual</string>
           <key>signingCertificate</key>
           <string>Developer ID Application</string>
       </dict>
       </plist>
       ```
       Note: `teamID` is intentionally omitted — it will be passed via environment variable in CI. This avoids committing personal team IDs.

    Do NOT add Sparkle's XPC services — the host app is not sandboxed, so they're unnecessary per Sparkle docs.
  </action>
  <verify>
    Run `xcodegen generate && xcodebuild build -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug CODE_SIGN_IDENTITY="-" CODE_SIGNING_ALLOWED=NO` and verify the build succeeds with Sparkle imported and CheckForUpdatesView compiled.
  </verify>
  <done>
    CloudMountApp.swift imports Sparkle, creates SPUStandardUpdaterController, and adds Check for Updates command. CheckForUpdatesView.swift exists with SPUUpdater binding. scripts/export-options.plist exists with developer-id method. Project builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. `xcodegen generate` succeeds
2. `xcodebuild build -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug CODE_SIGN_IDENTITY="-" CODE_SIGNING_ALLOWED=NO` completes with 0 errors
3. `grep -q "Sparkle" project.yml` confirms SPM dependency
4. `grep -q "SUFeedURL" CloudMount/Info.plist` confirms Sparkle feed URL
5. `grep -q "SPUStandardUpdaterController" CloudMount/CloudMountApp.swift` confirms updater integration
6. `test -f scripts/export-options.plist` confirms export options exist
</verification>

<success_criteria>
- Sparkle 2.x is a declared SPM dependency that resolves and builds
- CloudMountApp initializes Sparkle's updater controller on launch
- "Check for Updates…" menu command is wired to Sparkle
- Info.plist has v2.0.0 version, SUFeedURL, SUPublicEDKey
- ExportOptions.plist ready for Developer ID archive export
- Project builds successfully with no signing (ad-hoc for CI PR checks)
</success_criteria>

<output>
After completion, create `.planning/phases/08-distribution/08-01-SUMMARY.md`
</output>
