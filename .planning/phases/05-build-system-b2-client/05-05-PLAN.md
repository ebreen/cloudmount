---
phase: 05-build-system-b2-client
plan: 05
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - CloudMount/AppState.swift
  - CloudMount/Views/SettingsView.swift
  - CloudMount/Views/MenuContentView.swift
  - Sources/CloudMount/CredentialStore.swift
autonomous: true

must_haves:
  truths:
    - "Host app compiles and launches as a menu bar app with the new CloudMountKit stack"
    - "Settings credentials pane validates B2 credentials by calling B2Client.listBuckets()"
    - "No references to DaemonClient, MacFUSEDetector, or KeychainAccess remain in the app target"
    - "AppState uses CloudMountKit's CredentialStore and SharedDefaults for persistence"
    - "Old v1.0 CredentialStore.swift (with KeychainAccess import) is deleted"
  artifacts:
    - path: "CloudMount/AppState.swift"
      provides: "Rewired app state using CloudMountKit credential/config models"
      contains: "import CloudMountKit"
    - path: "CloudMount/Views/SettingsView.swift"
      provides: "Credentials pane using B2Client for validation, no daemon references"
      contains: "B2Client"
    - path: "CloudMount/Views/MenuContentView.swift"
      provides: "Menu bar view without macFUSE warning, using new mount config model"
      contains: "import CloudMountKit"
  key_links:
    - from: "AppState"
      to: "SharedDefaults"
      via: "Loads/saves account and mount configs"
      pattern: "SharedDefaults\\.shared"
    - from: "SettingsView"
      to: "B2Client"
      via: "Validates credentials by listing buckets"
      pattern: "B2Client.*listBuckets"
    - from: "SettingsView"
      to: "CredentialStore"
      via: "Saves/loads B2 account credentials"
      pattern: "CredentialStore"
---

<objective>
Rewire the host app (AppState, SettingsView, MenuContentView) to use CloudMountKit instead of the deleted DaemonClient and MacFUSEDetector. The settings pane validates credentials directly via B2Client.listBuckets(). Mount/unmount remains non-functional (wired in Phase 7) but the UI displays configured buckets from the new config model.

Purpose: Complete the Phase 5 deliverable — a buildable, launchable app with the new architecture, ready for FSKit integration.
Output: Updated host app files that compile against CloudMountKit, with credentials and bucket configuration working end-to-end.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-build-system-b2-client/05-RESEARCH.md
@.planning/phases/05-build-system-b2-client/05-CONTEXT.md
@.planning/phases/05-build-system-b2-client/05-04-SUMMARY.md
@CloudMount/AppState.swift
@CloudMount/Views/MenuContentView.swift
@CloudMount/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire AppState to use CloudMountKit</name>
  <files>
    CloudMount/AppState.swift
    Sources/CloudMount/CredentialStore.swift (delete if still exists)
  </files>
  <action>
    Rewrite `CloudMount/AppState.swift` to use CloudMountKit's credential store, config models, and shared defaults. This replaces all daemon/macFUSE dependencies.

    1. Delete `Sources/CloudMount/CredentialStore.swift` if it still exists (the old KeychainAccess-based version from v1.0). The replacement lives in CloudMountKit.

    2. Rewrite AppState:

    ```swift
    import SwiftUI
    import CloudMountKit

    @MainActor
    final class AppState: ObservableObject {
        // MARK: - Published state
        @Published var accounts: [B2Account] = []
        @Published var mountConfigs: [MountConfiguration] = []
        @Published var lastError: String?
        @Published var isConnected: Bool = false

        // MARK: - Credential & config stores (from CloudMountKit)
        let credentialStore = CredentialStore()
        let sharedDefaults = SharedDefaults.shared

        init() {
            loadState()
        }

        func loadState() {
            accounts = sharedDefaults.loadAccounts()
            mountConfigs = sharedDefaults.loadMountConfigurations()
        }

        // MARK: - Account management
        func addAccount(_ account: B2Account, applicationKey: String) throws {
            try credentialStore.saveAccount(account, applicationKey: applicationKey)
            var updated = accounts
            updated.append(account)
            accounts = updated
            sharedDefaults.saveAccounts(accounts)
        }

        func removeAccount(_ account: B2Account) {
            try? credentialStore.deleteAccount(id: account.id)
            accounts.removeAll { $0.id == account.id }
            // Also remove mount configs for this account
            mountConfigs.removeAll { $0.accountId == account.id }
            sharedDefaults.saveAccounts(accounts)
            sharedDefaults.saveMountConfigurations(mountConfigs)
        }

        // MARK: - Mount configuration management
        func addMountConfig(_ config: MountConfiguration) {
            mountConfigs.append(config)
            sharedDefaults.saveMountConfigurations(mountConfigs)
        }

        func removeMountConfig(_ config: MountConfiguration) {
            mountConfigs.removeAll { $0.id == config.id }
            sharedDefaults.saveMountConfigurations(mountConfigs)
        }

        // MARK: - Mount/Unmount (stub for Phase 7)
        func mount(_ config: MountConfiguration) async {
            // TODO: Phase 7 — wire to FSKit extension mount
            lastError = "Mount not yet available (coming in Phase 7)"
        }

        func unmount(_ config: MountConfiguration) async {
            // TODO: Phase 7 — wire to FSKit extension unmount
            lastError = "Unmount not yet available (coming in Phase 7)"
        }
    }
    ```

    Remove ALL of these from AppState:
    - `macFUSEInstalled`, `isCheckingMacFUSE`, `checkMacFUSE()` — gone
    - `isDaemonRunning`, `mountedBuckets`, `connectionHealth`, `recentErrors` — gone
    - `statusTimer`, `startStatusPolling()`, `updateDaemonStatus()` — gone
    - `storedBuckets` — replaced by accounts/mountConfigs
    - `BucketConfig` and `BucketConfigStore` types — replaced by MountConfiguration from CloudMountKit

    Note: The `CredentialStore` usage here refers to the one from CloudMountKit (native Security.framework), NOT the old one that used KeychainAccess. The old file at `Sources/CloudMount/CredentialStore.swift` should be deleted.

    Make sure `import CloudMountKit` is present. The framework must be linked to the host app target.
  </action>
  <verify>
    - `grep "import CloudMountKit" CloudMount/AppState.swift` — found
    - `grep "DaemonClient\|MacFUSEDetector\|macFUSEInstalled\|isDaemonRunning" CloudMount/AppState.swift | wc -l` — returns 0
    - `grep "KeychainAccess" CloudMount/ -r 2>/dev/null | wc -l` — returns 0
    - `ls Sources/CloudMount/CredentialStore.swift 2>/dev/null` — should not exist
  </verify>
  <done>AppState is rewired to use CloudMountKit's CredentialStore, SharedDefaults, B2Account, and MountConfiguration. No daemon or macFUSE references remain. Old v1.0 CredentialStore deleted.</done>
</task>

<task type="auto">
  <name>Task 2: Update SettingsView and MenuContentView for new architecture</name>
  <files>
    CloudMount/Views/SettingsView.swift
    CloudMount/Views/MenuContentView.swift
  </files>
  <action>
    Update the two view files to work with the new CloudMountKit-based AppState.

    **1. SettingsView.swift — CredentialsPane:**

    The credentials pane should:
    - Accept keyId and applicationKey from the user
    - On "Connect", create a B2Client to validate credentials (try B2Client(keyId:applicationKey:))
    - If successful, call `b2Client.listBuckets()` to get available buckets
    - Save the account via `appState.addAccount(...)` with the applicationKey going to Keychain
    - Display available buckets for the user to add as mount configurations
    - Replace `DaemonClient.shared.listBuckets(...)` with direct B2Client call
    - Replace `DaemonBucketInfo` with `B2BucketInfo` (from CloudMountKit)
    - Remove the daemon error message ("Daemon not running. Start it with: cd Daemon/...")

    ```swift
    private func connect() {
        isConnecting = true
        connectionStatus = .connecting

        Task {
            do {
                // Validate credentials by creating a B2Client
                let client = try await B2Client(keyId: keyId, applicationKey: applicationKey)
                let buckets = try await client.listBuckets()

                await MainActor.run {
                    isConnecting = false
                    availableBuckets = buckets
                    connectionStatus = .connected(bucketCount: buckets.count)

                    // Save account
                    let account = B2Account(label: "Default", keyId: keyId)
                    try? appState.addAccount(account, applicationKey: applicationKey)

                    // Auto-add buckets as mount configs
                    for bucket in buckets {
                        if !appState.mountConfigs.contains(where: { $0.bucketName == bucket.bucketName }) {
                            let config = MountConfiguration(
                                accountId: account.id,
                                bucketId: bucket.bucketId,
                                bucketName: bucket.bucketName,
                                mountPoint: "/Volumes/\(bucket.bucketName)",
                                autoMount: false,
                                cacheSettings: CacheSettings()
                            )
                            appState.addMountConfig(config)
                        }
                    }
                }
            } catch {
                await MainActor.run {
                    isConnecting = false
                    connectionStatus = .error(error.localizedDescription)
                }
            }
        }
    }
    ```

    Replace `DaemonBucketInfo` type references with `B2BucketInfo`.
    Replace `CredentialStore.shared.saveB2Credentials(...)` with the new flow above.
    Add `import CloudMountKit`.

    **BucketsPane:** Update to use `MountConfiguration` instead of `BucketConfig`:
    - `appState.mountConfigs` instead of `appState.bucketConfigs`
    - `MountConfiguration` properties (bucketName, mountPoint) instead of BucketConfig properties
    - Keep the add/remove bucket UI but wire to `appState.addMountConfig/removeMountConfig`

    **2. MenuContentView.swift:**

    - `import CloudMountKit`
    - Remove `macFUSEWarning` section entirely (already done in Plan 01, but verify)
    - Remove `if !appState.macFUSEInstalled` check
    - Update header status: show "Connected" if `appState.isConnected`, else "Not connected"
    - Replace `appState.bucketConfigs` with `appState.mountConfigs`
    - Replace `BucketConfig` with `MountConfiguration` in ForEach
    - Mount/unmount buttons call `appState.mount(config)` / `appState.unmount(config)` (stubs from Task 1)
    - Remove `healthColor` computed property (no more daemon health)
    - Use a simpler status indicator: green circle if any account exists, gray if none
    - Remove `recentErrors` section
    - Remove references to `DaemonMountInfo`, `DaemonErrorInfo`
    - Remove `.disabled(!appState.isDaemonRunning || !appState.macFUSEInstalled)` from buttons
    - Mount buttons should be disabled with a note that mounting is coming in Phase 7

    **Also update CloudMountApp.swift if needed:**
    - Remove the `BucketConfig` and `BucketConfigStore` structs (if they were left there by Plan 01 as stubs)
    - Ensure `import CloudMountKit` is present if needed
    - The AppState() initialization should work with the new constructor

    Make sure the entire host app compiles:
    `xcodebuild -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug build`
  </action>
  <verify>
    - `grep "import CloudMountKit" CloudMount/Views/SettingsView.swift` — found
    - `grep "import CloudMountKit" CloudMount/Views/MenuContentView.swift` — found
    - `grep "DaemonClient\|DaemonBucketInfo\|DaemonMountInfo\|DaemonError" CloudMount/ -r 2>/dev/null | wc -l` — returns 0
    - `grep "macFUSE\|MacFUSE\|macfuse\|MacFUSEDetector" CloudMount/ -r 2>/dev/null | wc -l` — returns 0
    - `grep "B2Client\|B2BucketInfo" CloudMount/Views/SettingsView.swift` — found (uses B2Client for validation)
    - `grep "MountConfiguration\|mountConfigs" CloudMount/Views/MenuContentView.swift` — found
    - `xcodebuild -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug build 2>&1 | tail -5` — BUILD SUCCEEDED (signing errors OK, compilation must succeed)
  </verify>
  <done>SettingsView validates credentials directly via B2Client, MenuContentView shows mount configs without daemon/macFUSE dependencies. Entire host app compiles against CloudMountKit. Mount/unmount buttons are stubs for Phase 7.</done>
</task>

</tasks>

<verification>
1. `xcodebuild -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug build` succeeds
2. Zero references to DaemonClient, MacFUSEDetector, KeychainAccess in any Swift file under CloudMount/
3. SettingsView credential validation uses B2Client.listBuckets() directly
4. AppState persists accounts via CloudMountKit CredentialStore + SharedDefaults
5. MenuContentView displays MountConfigurations, not BucketConfigs
6. Old Sources/CloudMount/CredentialStore.swift (KeychainAccess) is deleted
</verification>

<success_criteria>
- Host app builds and can launch as a menu bar app
- Credentials pane validates against real B2 API via B2Client
- Account and mount configuration persistence works via CloudMountKit
- No legacy daemon, macFUSE, or KeychainAccess references remain anywhere in the codebase
- Mount/unmount is stubbed (Phase 7 work) but the rest of the UI is functional
</success_criteria>

<output>
After completion, create `.planning/phases/05-build-system-b2-client/05-05-SUMMARY.md`
</output>
