---
phase: 05-build-system-b2-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Daemon/
  - Package.swift
  - Package.resolved
  - Sources/CloudMount/MacFUSEDetector.swift
  - Sources/CloudMount/DaemonClient.swift
  - CloudMount.xcodeproj
  - CloudMount/CloudMountApp.swift
  - CloudMount/Views/MenuContentView.swift
  - CloudMount/Views/SettingsView.swift
  - CloudMount/AppState.swift
  - CloudMount/Info.plist
  - CloudMount/CloudMount.entitlements
  - CloudMountExtension/CloudMountExtension.swift
  - CloudMountExtension/Info.plist
  - CloudMountExtension/CloudMountExtension.entitlements
  - CloudMountKit/CloudMountKit.h
autonomous: true

must_haves:
  truths:
    - "Xcode project builds successfully with xcodebuild"
    - "Three targets exist: CloudMount (app), CloudMountExtension (appex), CloudMountKit (framework)"
    - "No Rust source files, Cargo files, or macFUSE detection code remain in the repository"
    - "App and extension targets both have Keychain access group and App Group entitlements"
    - "Shared framework is embedded in host app and linked by extension"
  artifacts:
    - path: "CloudMount.xcodeproj/project.pbxproj"
      provides: "Xcode project with 3 targets"
    - path: "CloudMount/CloudMountApp.swift"
      provides: "Host app entry point"
    - path: "CloudMount/Info.plist"
      provides: "Host app Info.plist"
    - path: "CloudMount/CloudMount.entitlements"
      provides: "Host app entitlements with Keychain access group + App Group"
    - path: "CloudMountExtension/CloudMountExtension.swift"
      provides: "FSKit extension stub"
    - path: "CloudMountExtension/Info.plist"
      provides: "Extension Info.plist with NSExtension dict"
    - path: "CloudMountExtension/CloudMountExtension.entitlements"
      provides: "Extension entitlements matching host app"
    - path: "CloudMountKit/CloudMountKit.h"
      provides: "Shared framework umbrella header"
  key_links:
    - from: "CloudMount target"
      to: "CloudMountKit.framework"
      via: "Embed & Sign in Frameworks"
      pattern: "CloudMountKit"
    - from: "CloudMountExtension target"
      to: "CloudMountKit.framework"
      via: "Do Not Embed (linked only)"
      pattern: "CloudMountKit"
---

<objective>
Remove all Rust/macFUSE legacy code, delete SPM Package.swift, and create a new Xcode project with three targets: host app, FSKit extension stub, and shared framework. Configure entitlements for Keychain sharing and App Group between app and extension.

Purpose: Establish the Xcode multi-target build system that replaces the SPM+Rust architecture, giving every subsequent plan a clean foundation to build on.
Output: A buildable Xcode project with the existing SwiftUI menu bar app running in the host app target, a stub FSKit extension, and an empty shared framework ready for B2 client code.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-build-system-b2-client/05-RESEARCH.md
@.planning/phases/05-build-system-b2-client/05-CONTEXT.md
@Sources/CloudMount/CloudMountApp.swift
@Sources/CloudMount/MenuContentView.swift
@Sources/CloudMount/SettingsView.swift
@Sources/CloudMount/CredentialStore.swift
@Sources/CloudMount/MacFUSEDetector.swift
@Sources/CloudMount/DaemonClient.swift
@Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Rust daemon, macFUSE, SPM, and legacy files</name>
  <files>
    Daemon/ (delete entire directory)
    Package.swift (delete)
    Package.resolved (delete)
    .build/ (delete — SPM build cache)
    Sources/CloudMount/MacFUSEDetector.swift (delete)
    Sources/CloudMount/DaemonClient.swift (delete)
    .gitignore (update)
  </files>
  <action>
    1. Delete the entire `Daemon/` directory (Rust daemon source + Cargo files + build artifacts).
    2. Delete `Package.swift` and `Package.resolved` (SPM manifest — replaced by Xcode project).
    3. Delete `.build/` directory (SPM build cache).
    4. Delete `Sources/CloudMount/MacFUSEDetector.swift` (macFUSE detection — no longer needed).
    5. Delete `Sources/CloudMount/DaemonClient.swift` (Unix socket IPC to Rust daemon — replaced by direct B2 client).
    6. Update `.gitignore`:
       - Remove the `Daemon/CloudMountDaemon/target/` line (no more Rust)
       - Remove `Package.resolved` line (no more SPM)
       - Keep `.build/` for now (might still be referenced)
       - Add `*.xcodeproj/xcuserdata/` and `*.xcworkspace/` if not already present
       - Add `DerivedData/` if not already present
    7. Do NOT delete `Sources/CloudMount/CredentialStore.swift` yet — it will be replaced in Plan 02.
    8. Do NOT delete the remaining Swift files (CloudMountApp.swift, MenuContentView.swift, SettingsView.swift) — they move to the new project structure in Task 2.

    Also remove these leftover Tauri/web files if they still exist on disk (they're gitignored but may be present):
    - `src/`, `src-tauri/`, `node_modules/`, `dist/`, `package.json`, `package-lock.json`, `tsconfig.json`, `vite.config.ts`, `index.html`
    - `Resources/` directory (empty, from SPM)
    - `public/` directory (from old Tauri)
  </action>
  <verify>
    - `find . -name "*.rs" -not -path "./.git/*" -not -path "./.planning/*" | wc -l` returns 0
    - `find . -name "Cargo.*" -not -path "./.git/*" | wc -l` returns 0
    - `ls Sources/CloudMount/MacFUSEDetector.swift 2>/dev/null` returns nothing
    - `ls Sources/CloudMount/DaemonClient.swift 2>/dev/null` returns nothing
    - `ls Package.swift 2>/dev/null` returns nothing
  </verify>
  <done>All Rust source, Cargo files, macFUSE detection code, daemon client, and SPM manifest are removed from the working directory. Leftover Tauri/web files also cleaned up.</done>
</task>

<task type="auto">
  <name>Task 2: Create Xcode project with three targets and move Swift files</name>
  <files>
    CloudMount.xcodeproj/project.pbxproj
    CloudMount/CloudMountApp.swift
    CloudMount/Views/MenuContentView.swift
    CloudMount/Views/SettingsView.swift
    CloudMount/AppState.swift
    CloudMount/Info.plist
    CloudMount/CloudMount.entitlements
    CloudMountExtension/CloudMountExtension.swift
    CloudMountExtension/Info.plist
    CloudMountExtension/CloudMountExtension.entitlements
    CloudMountKit/CloudMountKit.h
  </files>
  <action>
    Create a new Xcode project from the command line using `xcodegen` or by writing the project structure manually. The project needs three targets:

    **Option A (preferred): Use `xcodegen`**
    1. Install xcodegen if not present: `brew install xcodegen`
    2. Create `project.yml` with three targets:
       - `CloudMount`: macOS app (menu bar), deployment target macOS 26.0, Swift 6.0
       - `CloudMountExtension`: macOS app extension (.appex), deployment target macOS 26.0
       - `CloudMountKit`: macOS framework, deployment target macOS 26.0
    3. Run `xcodegen generate`
    4. Delete `project.yml` after generation (or keep it — either way)

    **Option B (fallback): Create project manually**
    If xcodegen is unavailable, create the directory structure and use `swift package init` as a bootstrap, then manually create the pbxproj. This is harder — prefer Option A.

    **Directory structure to create:**
    ```
    CloudMount/                          # Host app target
    ├── CloudMountApp.swift              # Move from Sources/CloudMount/, MODIFY to remove macFUSE/daemon refs
    ├── Views/
    │   ├── MenuContentView.swift        # Move from Sources/CloudMount/, MODIFY to remove macFUSE/daemon refs
    │   └── SettingsView.swift           # Move from Sources/CloudMount/, MODIFY to remove macFUSE/daemon refs
    ├── AppState.swift                   # Extract from CloudMountApp.swift, MODIFY to stub out daemon deps
    ├── Info.plist
    └── CloudMount.entitlements

    CloudMountExtension/                 # FSKit extension target (stub)
    ├── CloudMountExtension.swift        # Minimal stub
    ├── Info.plist                       # NSExtension dict
    └── CloudMountExtension.entitlements

    CloudMountKit/                       # Shared framework
    └── CloudMountKit.h                  # Umbrella header (may be empty for Swift-only)
    ```

    **Move and modify existing Swift files:**

    a) Move `Sources/CloudMount/CloudMountApp.swift` → `CloudMount/CloudMountApp.swift`
       - Remove `BucketConfig` struct (will be replaced by MountConfiguration in Plan 02)
       - Remove `BucketConfigStore` struct
       - Extract `AppState` class into `CloudMount/AppState.swift`

    b) In `CloudMount/AppState.swift` (extracted from CloudMountApp.swift):
       - Remove `macFUSEInstalled` and `isCheckingMacFUSE` properties
       - Remove `checkMacFUSE()` method
       - Remove `isDaemonRunning` and all daemon-related properties
       - Remove `mountedBuckets: [DaemonMountInfo]`
       - Remove `connectionHealth` and `recentErrors`
       - Remove `statusTimer` and `startStatusPolling()` and `updateDaemonStatus()`
       - Remove `mountBucket()` and `unmountBucket()` (daemon IPC)
       - Keep `bucketConfigs`, `addBucket`, `removeBucket`, `clearAllBuckets` as stubs (they'll be rewired in Plan 05)
       - Add `@Published var lastError: String?` (keep this one)
       - The class should compile but be non-functional — a shell that Plan 05 will fill in

    c) Move `Sources/CloudMount/MenuContentView.swift` → `CloudMount/Views/MenuContentView.swift`
       - Remove the `macFUSEWarning` section entirely
       - Remove the `if !appState.macFUSEInstalled` check
       - Change status text from daemon-based to a simple placeholder (e.g., "Not connected")
       - Remove `DaemonMountInfo`, `DaemonErrorInfo` references
       - Remove `recentErrors` section
       - Make mount/unmount buttons disabled with a TODO comment for Plan 05
       - Keep the visual structure intact — header, buckets section, actions section

    d) Move `Sources/CloudMount/SettingsView.swift` → `CloudMount/Views/SettingsView.swift`
       - Replace `DaemonClient.shared.listBuckets(...)` with a TODO stub
       - Replace `DaemonBucketInfo` with a placeholder
       - Remove the daemon error message ("Daemon not running. Start it with: cd Daemon/...")
       - Keep the credentials UI structure — just make connect() a no-op for now
       - Keep the buckets pane structure

    e) Delete `Sources/` directory entirely after moving files.

    **Create new files:**

    f) `CloudMountExtension/CloudMountExtension.swift`:
       ```swift
       import Foundation

       // FSKit extension entry point — stub for Phase 5
       // Full implementation in Phase 6
       class CloudMountExtension {
           // Placeholder
       }
       ```

    g) `CloudMountExtension/Info.plist`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>NSExtension</key>
           <dict>
               <key>NSExtensionPointIdentifier</key>
               <string>com.apple.filesystems.fs-module</string>
               <key>NSExtensionPrincipalClass</key>
               <string>$(PRODUCT_MODULE_NAME).CloudMountExtension</string>
           </dict>
           <key>CFBundleName</key>
           <string>CloudMountExtension</string>
           <key>CFBundleIdentifier</key>
           <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
           <key>CFBundleVersion</key>
           <string>1</string>
           <key>CFBundleShortVersionString</key>
           <string>2.0.0</string>
       </dict>
       </plist>
       ```

    h) `CloudMountExtension/CloudMountExtension.entitlements`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>com.apple.security.app-sandbox</key>
           <false/>
           <key>keychain-access-groups</key>
           <array>
               <string>$(AppIdentifierPrefix)com.cloudmount.shared</string>
           </array>
           <key>com.apple.security.application-groups</key>
           <array>
               <string>group.com.cloudmount.shared</string>
           </array>
       </dict>
       </plist>
       ```

    i) `CloudMount/Info.plist`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>CFBundleName</key>
           <string>CloudMount</string>
           <key>CFBundleIdentifier</key>
           <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
           <key>CFBundleVersion</key>
           <string>1</string>
           <key>CFBundleShortVersionString</key>
           <string>2.0.0</string>
           <key>LSUIElement</key>
           <true/>
           <key>NSHumanReadableCopyright</key>
           <string>Copyright © 2026. All rights reserved.</string>
       </dict>
       </plist>
       ```
       Note: `LSUIElement = true` makes it a menu bar-only app (no Dock icon).

    j) `CloudMount/CloudMount.entitlements`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>com.apple.security.app-sandbox</key>
           <false/>
           <key>keychain-access-groups</key>
           <array>
               <string>$(AppIdentifierPrefix)com.cloudmount.shared</string>
           </array>
           <key>com.apple.security.application-groups</key>
           <array>
               <string>group.com.cloudmount.shared</string>
           </array>
       </dict>
       </plist>
       ```

    k) `CloudMountKit/CloudMountKit.h`:
       ```c
       // CloudMountKit — Shared framework for CloudMount
       // This framework contains B2 client, credential store, cache, and config models
       // shared between the host app and FSKit extension.
       ```

    **xcodegen project.yml configuration (if using xcodegen):**
    - Host app bundle ID: `com.cloudmount.app`
    - Extension bundle ID: `com.cloudmount.app.extension`
    - Framework bundle ID: `com.cloudmount.kit`
    - Host app: embed CloudMountKit (Embed & Sign), embed CloudMountExtension
    - Extension: link CloudMountKit (Do Not Embed)
    - All targets: macOS deployment target 26.0
    - Host app: `INFOPLIST_FILE = CloudMount/Info.plist`, `CODE_SIGN_ENTITLEMENTS = CloudMount/CloudMount.entitlements`
    - Extension: `INFOPLIST_FILE = CloudMountExtension/Info.plist`, `CODE_SIGN_ENTITLEMENTS = CloudMountExtension/CloudMountExtension.entitlements`
    - Framework: `DEFINES_MODULE = YES`
    - Signing: automatic, development team can be empty for now
  </action>
  <verify>
    - `xcodebuild -project CloudMount.xcodeproj -list` shows three targets: CloudMount, CloudMountExtension, CloudMountKit
    - `xcodebuild -project CloudMount.xcodeproj -scheme CloudMount -configuration Debug build 2>&1 | tail -5` shows BUILD SUCCEEDED (or at minimum, no missing file errors — signing errors are OK)
    - `ls Sources/` returns "No such file or directory" (old directory gone)
    - `ls CloudMount/CloudMountApp.swift` exists
    - `ls CloudMount/Views/MenuContentView.swift` exists
    - `ls CloudMountExtension/CloudMountExtension.swift` exists
    - `ls CloudMountKit/CloudMountKit.h` exists
    - `grep -r "macFUSE\|MacFUSE\|macfuse" CloudMount/ CloudMountExtension/ CloudMountKit/ 2>/dev/null | wc -l` returns 0
    - `grep -r "DaemonClient\|DaemonError\|DaemonMountInfo\|DaemonBucketInfo\|DaemonResponse" CloudMount/ 2>/dev/null | wc -l` returns 0
  </verify>
  <done>
    Xcode project builds with three targets. Existing Swift UI code is moved into host app target with daemon/macFUSE references removed. Extension is a stub with correct entitlements. Shared framework target is empty and ready for B2 client code. Old Sources/ directory is deleted.
  </done>
</task>

</tasks>

<verification>
1. `find . -name "*.rs" -not -path "./.git/*" -not -path "./.planning/*" | wc -l` returns 0 — no Rust files
2. `find . -name "Cargo.*" -not -path "./.git/*" | wc -l` returns 0 — no Cargo files
3. `grep -r "macFUSE\|MacFUSE\|macfuse\|MacFUSEDetector" --include="*.swift" . 2>/dev/null | grep -v ".planning" | wc -l` returns 0
4. `grep -r "DaemonClient" --include="*.swift" . 2>/dev/null | grep -v ".planning" | wc -l` returns 0
5. `xcodebuild -project CloudMount.xcodeproj -list` shows CloudMount, CloudMountExtension, CloudMountKit
6. Both entitlements files contain `keychain-access-groups` and `application-groups`
</verification>

<success_criteria>
- Xcode project with 3 targets builds (signing errors acceptable, compilation must succeed)
- Zero Rust files, zero Cargo files, zero macFUSE references in Swift code
- Host app Swift files compile without daemon/macFUSE dependencies
- Entitlements configured for Keychain sharing and App Group on both app and extension
- Old Sources/ directory deleted, old Package.swift deleted
</success_criteria>

<output>
After completion, create `.planning/phases/05-build-system-b2-client/05-01-SUMMARY.md`
</output>
